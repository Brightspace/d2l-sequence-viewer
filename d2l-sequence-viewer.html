<link rel="import" href="./bower_components/d2l-sequence-navigator/d2l-sequence-navigator.html">
<link rel="import" href="./bower_components/d2l-typography/d2l-typography.html">
<link rel="import" href="./bower_components/d2l-colors/d2l-colors.html">
<link rel="import" href="./bower_components/d2l-organizations/components/d2l-organization-name.html">
<link rel="import" href="./components/sequence-viewer-header.html">
<link rel="import" href="./bower_components/d2l-localize-behavior/d2l-localize-behavior.html">
<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="./bower_components/d2l-sequences/components/d2l-sequences-content-router.html">
<link rel="import" href="./bower_components/d2l-sequences/components/d2l-sequences-content-eol-main.html">
<link rel="import" href="./bower_components/d2l-alert/d2l-alert-toast.html">
<link rel="import" href="./bower_components/d2l-link/d2l-link.html">

<dom-module id="d2l-sequence-viewer">
	<template>
		<custom-style include="d2l-typography">
			<style is="custom-style" include="d2l-typography">
				:host {
					display: block;
					color: var(--d2l-color-ferrite);
					@apply --d2l-body-standard-text;
				}
				.back-icon {
					padding-bottom: 2px;
				}
				.back-text:hover {
					cursor: pointer;
				}
				.topbar {
					position: fixed;
					top: 0px;
					left: -10px;
					width: calc(100% + 10px);
					height: 30px;
					z-index: 2;
					box-shadow: 2px 0px 3px 2px rgba(214,220,229,0.5); /* 50% D6DCE5 */
				}
				#sidebar-occlude {
					width: calc(50% - 615px - 2px);
					height: 100%;
					background: white;
					position: fixed;
					top: 58px;
					left: 0px;
					z-index: 2;
				}
				#sidebar {
					width: 330px;
					position: fixed;
					z-index: 1;
					top: 56px;
					bottom: 0px;
					padding: 0px;
					background: linear-gradient(to right, #F9FAFC, #FFFFFF);
					box-shadow: 0px 2px 3px 2px rgba(214,220,229,0.5); /* 50% D6DCE5 */
					left: calc(50% - 615px);
					transition: margin-left 0.5s;
				}
				#sidebar.offscreen {
					margin-left: -400px;
				}
				.viewer {
					position: relative;

					top: 56px;
					bottom: 0px;
					width: 100%;
					overflow-y: auto;
				}
				.viewframe{
					height: 100vw;
					width: 1230px;
					margin: auto;
				}
				.hide {
					display: none;
				}
				d2l-alert-toast {
					font-size: 20px !important;
				}
				.toastName {
					font-weight: bold;
				}
				@media(max-width: 1230px) {
					#sidebar {
						left: 0px;
					}
				}
				@media(max-width: 720px) {
					#sidebar {
						left: 0px;
					}
				}
			</style>
		</custom-style>
		<siren-entity href="[[_intermediateOrganizationHref]]" token="[[token]]" entity="{{organizationEntity}}"></siren-entity>
		<d2l-sequences-module-name class="hide" href="[[moduleHref]]" token="[[token]]" title="{{_moduleName}}"></d2l-sequences-module-name>
		<d2l-organization-name class="hide" href="[[organizationHref]]" token="[[token]]" name="{{_courseName}}"></d2l-organization-name>
		<d2l-sequence-viewer-header class="topbar"
			href="{{href}}"
			token="[[token]]"
			role="banner">
			<span slot="d2l-flyout-menu">
				<d2l-icon-button icon="d2l-tier3:menu" on-click="_toggleSlideSidebar">[[localize('toggleNavMenu')]]</d2l-icon-button>
			</span>
			<span slot="back-button">
				<d2l-icon-button
					class$="[[backButtonClass]]"
					icon="d2l-tier1:chevron-left"
					type="button"
					text="Activity"
					on-click="_onClickBack"
				>[[localize('backToModule', 'module', _moduleName, 'course', _courseName)]]</d2l-icon-button>
			</span>
			<span
				class$="[[backTextClass]]"
				slot="d2l-back-to-module"
				on-click="_onClickBack"
				tabindex="-1"
			>
				[[localize('backToModule', 'module', _moduleName, 'course', _courseName)]]
			</span>
		</d2l-sequence-viewer-header>
		<div id="sidebar-occlude">
		</div>
		<div id="sidebar">
			<d2l-sequence-navigator
				href="{{href}}"
				entity="[[entity]]"
				token="[[token]]"
				role="navigation"
			></d2l-sequence-navigator>
		</div>
		<div class="viewframe" on-click="_closeSlidebar" role="main" tabindex="0">
			<template is="dom-if" if="[[isEndOfLesson]]">
				<d2l-sequences-content-eol-main
					class="viewer"
					href="{{href}}"
					token="[[token]]"
					return-url="[[returnUrl]]">
				</d2l-sequences-content-eol-main>
			</template>
			<template is="dom-if" if="[[!isEndOfLesson]]">
				<d2l-sequences-content-router
					class="viewer"
					href="[[href]]"
					token="[[token]]"
				></d2l-sequences-content-router>
			</template>
			<d2l-alert-toast
				class="d2l-typography"
				id="toast">
				<p>[[ toast.message ]]</p>
				<p class="toastName">[[ toast.name ]]</p>
				<d2l-link on-click="_navigateTo">[[localize('goBack')]]</d2l-link>
			</d2l-alert-toast>
		</div>
	</template>

	<script>
		/*
		* @appliesMixin D2L.PolymerBehaviors.LocalizeBehavior
		* @appliesMixin D2L.PolymerBehaviors.Siren.EntityBehavior
		* @memberOf D2L.Polymer.Mixins;
		* @mixes D2L.PolymerBehaviors.Siren.EntityBehavior
		* @extends Polymer.AppLocalizeBehavior
		*/
		class D2LSequenceViewer extends Polymer.mixinBehaviors([
			D2L.PolymerBehaviors.Siren.EntityBehavior,
			D2L.PolymerBehaviors.LocalizeBehavior
		], Polymer.Element) {
			static get is() {
				return 'd2l-sequence-viewer';
			}
			static get properties() {
				return {
					href: {
						type: String,
						reflectToAttribute: true,
						notify: true
					},
					title: {
						type: Object,
						computed: '_getTitle(entity)'
					},
					getToken: {
						type: Object,
						computed: '_getToken(token)'
					},
					backButtonClass: {
						type: String,
						computed: '_backButtonClass(returnUrl)'
					},
					backTextClass: {
						type: String,
						computed: '_backTextClass(returnUrl)'
					},
					returnUrl: {
						type: String,
						value: false
					},
					moduleHref: {
						type: Object,
						computed: '_getHrefByRel(entity, "up")'
					},
					organizationEntity: {
						type: Object
					},
					organizationHref: {
						type: String,
						computed: '_getOrganizationHref(organizationEntity)'
					},
					toast: {
						type: Object,
					},
					_courseName: {
						type: String,
					},
					_intermediateOrganizationHref: {
						type: String
					},
					_moduleName: {
						type: String
					},
					_blurListener: {
						type: Object
					},
					_toastListener: {
						type: Object
					},
					isEndOfLesson: {
						type: Boolean,
						computed: '_isEndOfLesson(entity)'
					}
				};
			}
			static get observers() {
				return ['_initialize(href)'];
			}
			_initialize(href) {
				this._intermediateOrganizationHref = href;
			}
			_isEndOfLesson(entity) {
				return entity && entity.hasClass('end-of-sequence');
			}
			connectedCallback() {
				super.connectedCallback();
				this.loadResources(this.resolveUrl('./locales.json'));

				// For ASV, the blur event is an indicator than an iframe took focus
				// from our full-screen application.  Currently, the only thing that
				// can do this is a content iframe.
				this._blurListener = window.addEventListener('blur', () => {
					this._closeSlidebar();
				});

				this._toastListener = window.addEventListener('toast', ({detail}) => {
					this.toast = detail;
					this.$.toast.open = true;
				});
			}
			disconnectedCallback() {
				super.disconnectedCallback();
				window.removeEventListener('blur', this._blurListener);
				this._blurListener = null;
				window.removeEventListener('toast', this._toastListener);
				this._toastListener = null;
			}
			_closeSlidebar() {
				this.$.sidebar.classList.add('offscreen');
			}
			_onClickBack() {
				if ( !this.returnUrl ) {
					return;
				}

				if ( window.parent === window ) {
					window.location.href = this.returnUrl;
					return;
				}

				// If we're in an iframe we need to post a message to do the navigation for us
				window.parent.postMessage(JSON.stringify({
					eventType: 'd2l-sequence-viewer-return',
					returnUrl: this.returnUrl
				}), '*');
			}
			_getHrefByRel(entity, relation) {
				const link = entity && entity.getLinkByRel(relation);
				return link && link.href || '';
			}
			_getTitle(entity) {
				return entity && entity.properties && entity.properties.title || '';
			}
			_getToken(token) {
				return () => { return Promise.resolve(token); };
			}
			_getOrganizationHref(entity) {
				const upLink = entity && entity.getLinkByRel( 'up' );
				if ( !upLink ) {
					return '';
				}
				if ( upLink.rel.indexOf( 'https://api.brightspace.com/rels/organization' ) >= 0 ) {
					return upLink.href;
				}
				this._intermediateOrganizationHref = upLink.href;
				return '';
			}
			_backButtonClass(returnUrl) {
				return !returnUrl
					? 'back-icon hide'
					: 'back-icon';
			}
			_backTextClass(returnUrl) {
				return !returnUrl
					? ''
					: 'back-text';
			}
			_toggleSlideSidebar() {
				this.$.sidebar.classList.toggle('offscreen');
			}
			_navigateTo() {
				this.href = this.toast.url;
			}
		}
		customElements.define(D2LSequenceViewer.is, D2LSequenceViewer);
	</script>
</dom-module>
