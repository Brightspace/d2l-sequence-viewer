<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer-siren-mixins/siren-entity-mixin.html">
<link rel="import" href="../d2l-activity-details-ui/src/d2l-activity-details.html">
<link rel="import" href="../d2l-sequence-navigator/d2l-sequence-navigator.html">
<link rel="import" href="../d2l-typography/d2l-typography.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-organizations/components/d2l-organization-name.html">
<link rel="import" href="./components/sequence-viewer-header.html">
<link rel="import" href="../d2l-localize-behavior/d2l-localize-behavior.html">

<dom-module id="d2l-sequence-viewer">
	<template>
		<custom-style include="d2l-typography">
			<style is="custom-style" include="d2l-typography">
				:host {
					display: block;
				}
				.topbar {
					position: fixed;
					top: 0px;
					height: 30px;
					z-index: 2;
					box-shadow: 2px 0px 3px 2px rgba(214,220,229,0.5); /* 50% D6DCE5 */
				}
				#sidebar {
					width: 330px;
					position: fixed;
					z-index: 1;
					top: 56px;
					bottom: 0px;
					padding: 0px;
					background: linear-gradient(to right, #F9FAFC, #FFFFFF);
					box-shadow: 0px 2px 3px 2px rgba(214,220,229,0.5); /* 50% D6DCE5 */
					margin-left: 0px;
					transition: margin-left 0.5s;
				}
				.viewer {
					position: fixed;
					top: 56px;
					bottom: 0px;
					width: 100%;
					overflow-y: auto;
				}
				.hide {
					display: none;
				}
			</style>
		</custom-style>
		<d2l-siren-entity href="[[_intermediateOrganizationHref]]" token="[[token]]" entity="{{organizationEntity}}"></d2l-siren-entity>
		<d2l-sequences-module-name class="hide" href="[[moduleHref]]" token="[[token]]" title="{{_moduleName}}"></d2l-sequences-module-name>
		<d2l-organization-name class="hide" href="[[organizationHref]]" token="[[token]]" name="{{_courseName}}"></d2l-organization-name>
		<d2l-sequence-viewer-header class="topbar"
			href="{{currentActivity}}"
			token="[[token]]">
			<span slot="d2l-flyout-menu">
				<d2l-icon-button icon="d2l-tier3:menu" on-click="_slideSidebar"></d2l-icon-button>
			</span>
			<span slot="d2l-back-to-module">[[localize('backToModule', 'module', _moduleName, 'course', _courseName)]]</span>
		</d2l-sequence-viewer-header>
		<div id="sidebar">
			<d2l-sequence-navigator
				href="{{currentActivity}}"
				token="[[token]]"
			></d2l-sequence-navigator>
		</div>
		<div>
		<d2l-activity-details class="viewer"
			user-url="[[currentActivity]]"
			get-token="[[getToken]]"
			assignment-details-enabled="false"
			user-activity-usage-href=""
		></d2l-activity-details>
		</div>
	</template>

	<script>
		/*
			@mixes SirenEntityMixin
			@demo demos/index.html
		*/
		class D2LSequenceViewer extends Polymer.mixinBehaviors(D2L.PolymerBehaviors.LocalizeBehavior, D2L.Polymer.Mixins.SirenEntityMixin(Polymer.Element)) {
			static get is() {
				return 'd2l-sequence-viewer';
			}
			static get properties() {
				return {
					currentActivity: {
						type: String
					},
					title: {
						type: Object,
						computed: '_getTitle(entity)'
					},
					getToken: {
						type: Object,
						computed: '_getToken(token)'
					},
					moduleHref: {
						type: Object,
						computed: '_getHrefByRel(entity, "up")'
					},
					organizationEntity: {
						type: Object
					},
					organizationHref: {
						type: String,
						computed: '_getOrganizationHref(organizationEntity)'
					},
					_courseName: {
						type: String,
					},
					_intermediateOrganizationHref: {
						type: String
					},
					_moduleName: {
						type: String
					}
				};
			}
			static get observers() {
				return ['_initialize(href)'];
			}
			_initialize(href) {
				this._intermediateOrganizationHref = href;
			}
			connectedCallback() {
				super.connectedCallback();
				this.loadResources(this.resolveUrl('./locales.json'));
			}
			_getHrefByRel(entity, relation) {
				const link = entity.getLinkByRel(relation);
				return link && link.href || '';
			}
			_getTitle(entity) {
				return entity && entity.properties && entity.properties.title || '';
			}
			_getToken(token) {
				return () => { return Promise.resolve(token); };
			}
			_getOrganizationHref(entity) {
				const upLink = entity.getLinkByRel( 'up' );
				if ( !upLink ) {
					return '';
				}
				if ( upLink.rel.indexOf( 'https://api.brightspace.com/rels/organization' ) >= 0 ) {
					return upLink.href;
				}
				this._intermediateOrganizationHref = upLink.href;
				return '';
			}
			_slideSidebar() {
				if ( getComputedStyle(this.$.sidebar).marginLeft === '0px' ) {
					this.$.sidebar.style.marginLeft = '-330px';
				} else {
					this.$.sidebar.style.marginLeft = '0px';
				}
			}
		}
		customElements.define(D2LSequenceViewer.is, D2LSequenceViewer);
	</script>
</dom-module>
